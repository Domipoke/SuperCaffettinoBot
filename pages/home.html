<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

</head>

<body>
    <div class="header"></div>
    <div class="body">
        <div id="accordion">
            <div class="card">
                <div class="card-header" id="headingOne">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLyricsToJSON" aria-expanded="false" aria-controls="collapseLyricsToJSON">
                            Lyrics To JSON
                        </button>
                    </h5>
                </div>

                <div id="collapseLyricsToJSON" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <textarea class="form-control" aria-label="With textarea" id="LyricsToJSONinput"></textarea>
                            </div>
                            <div class="col-8">
                                <button id="LyricsToJSONbtn" class="btn">Generate</button>
                                <p><small id="LyricsToJSONresult"></small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="accordion">
            <div class="card">
                <div class="card-header" id="headingOne">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#PlayVideoFromYT" aria-expanded="false" aria-controls="collapseGdond">
                            Play a video from Youtube
                        </button>
                    </h5>
                </div>

                <div id="collapsePlayVideoFromYT" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <div class="row">
                            <div id="yt_iframe">
                                <div>
                                    <div class="input-group">
                                        <input type="text" id="yt_search_input" class="form-control" placeholder="Search" aria-describedby="addon-wrapping">
                                        <button class="btn" id="yt_search">Search</button>
                                    </div>
                                </div>
                                <div id="results">

                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="accordion">
            <div class="card">
                <div class="card-header" id="headingOne">
                    <h5 class="mb-0">
                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGdond" aria-expanded="false" aria-controls="collapseGdond">
                            Duce o non Duce?
                        </button>
                    </h5>
                </div>

                <div id="collapseGdond" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text" id="basic-addon1">Nome</span>
                                        <input type="text" class="form-control" list="dond_names" value="" aria-describedby="basic-addon1" id="dond_name">
                                        <datalist id="dond_names">
                                            
                                        </datalist>
                                        
                                      </div>
                                    <div class="input-group">
                                        <span class="input-group-text">Descrizione</span>
                                        <div class="form-control" aria-label="With textarea" style="height: fit-content; max-height: 500px;overflow-y:auto;">
                                            <div id="dond_desc"></div>
                                        </div>
                                    </div>
                                    <!-- Canvas drawing -->
                                    <div class="input-group">
                                        <span class="input-group-text" id="addon-wrapping">ImageLink</span>
                                        <input type="text" class="form-control" placeholder="Url" id="dond_img" aria-label="Username" aria-describedby="addon-wrapping">
                                        <!-- <input type="file" class="form-control" id="dond_img" aria-describedby="inputGroupFileAddon04" aria-label="Upload"> -->
                                        <!-- <button class="btn btn-outline-secondary" type="button" id="inputGroupFileAddon04" disabled>Crea...</button> -->
                                    </div>
                                    <div class="btn-group" role="group" aria-label="Basic outlined example">
                                        <button type="button" class="btn btn-outline-primary" id="dond_prev">Preview</button>
                                        <button type="button" class="btn btn-outline-primary" id="dond_upd">Update</button>
                                    </div>                                    
                                </div>
                            </div>
                            <div class="col-4" style="max-width: 300px">
                                <div class="card">
                                    <div class="card-header">
                                        <span>Duce</span><span> o </span><span>non duce?</span>
                                    </div>
                                    <img src="" alt="" class="card-img-top" id="dond_res_img" style="max-width: 300px" >
                                    <div class="card-body">
                                        <h5 class="card-title" id="dond_res_name"></h5>
                                        <p class="card-text" id="dond_res_desc"></p>
                                    </div>
                                </div>
                            </div>
                         
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="./lg.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        /*
        setup
        */
        document.getElementById("dond_name").value=""
        document.getElementById("dond_img").value=""
        Array.from(["dond_desc"]).forEach(x=>{
            try {
                var quill = new Quill('#'+x, {
                    modules: { toolbar: true },
                    theme: 'snow'
                });
            } catch (error) {
                console.log("Quill error: ", error)
                // var pta = document.getElementById(x)
                // var ta = document.createElement("textarea")
                // ta.id = x
                // ta.classList=pta.classList
                // pta.replaceWith(ta)
            }
        })

        // richiedi la lista delle persone già aggiunte al socket, se nome è presente, modifica anche gli altri campi in modo da consentire piccole modifiche, se il nome non è già usato allora creane uno nuovo.
        var socket=io(localStorage.getItem("caffettino_socketurl"))
        if (localStorage.getItem("caffettino_isLg")=="true") {
            console.log("is lg")
            socket.on("setdatalist",(a)=>{
                console.log(a)
                Array.from(a).filter(x=>x.name).map(function (x) {
                    var ax = x
                    var d = document.createElement("option")
                    d.value=ax.name
                    d.setAttribute("aria-name",ax.name)
                    d.setAttribute("aria-lore",ax.lore)
                    d.setAttribute("aria-img",ax.image)
                    return d
                }).forEach(x=>document.getElementById("dond_names").appendChild(x))
            })

            socket.emit("requestducelist", {onsuccess: "setdatalist"})
        }
        document.getElementById("dond_name")
        .addEventListener("change",(e)=>{
            document.getElementById("dond_res_name").innerHTML=e.target.value
            var x = document.getElementById("dond_names")
            var ch = Array.from(x.children).find(l=>l.getAttribute("aria-name")==e.target.value)
            if (ch){
                document.getElementById("dond_desc").getElementsByClassName("ql-editor")[0].innerHTML=ch.getAttribute("aria-lore")
                document.getElementById("dond_res_desc").innerHTML=ch.getAttribute("aria-lore")
                document.getElementById("dond_res_img").setAttribute('src', ch.getAttribute("aria-img"))
                document.getElementById("dond_img").value= ch.getAttribute("aria-img")
            } else {
                console.log("no ch")
            }
        })
        document.getElementById("dond_desc").getElementsByClassName("ql-editor")[0]
        .addEventListener("change",(e)=>{
            document.getElementById("dond_res_desc").innerHTML=e.target.innerHTML
        })
        var i = document.getElementById("dond_img")
        i.addEventListener("change",()=>{
            // if (i.files[0]) {
            //     var reader = new FileReader();
            //     reader.onload=(e)=>{
            //         document.getElementById("dond_res_img").setAttribute('src', e.target.result)
            //     }
            //     reader.readAsDataURL(i.files[0]);
            // }
            document.getElementById("dond_res_img").setAttribute('src', i.value)
        })
        function upd() {
            prv((data)=>{
                if (localStorage.getItem("caffettino_isLg")=="true") {
                    socket.emit("game_duceononduce",data)
                }
            })
        }
        function prv(cb=(a)=>{console.log(a)}) {
            document.getElementById("dond_res_name").innerHTML=document.getElementById("dond_name").value
            document.getElementById("dond_res_desc").innerHTML=document.getElementById("dond_desc").getElementsByClassName("ql-editor")[0].innerHTML
            // if (i.files[0]) {
            //     var reader = new FileReader();
            //     reader.onload=(e)=>{
                    
            //     }
            //     reader.readAsDataURL(i.files[0])
            // }
            document.getElementById("dond_res_img").setAttribute('src',  i.value)
            if (typeof cb=="function") {
                cb({
                    name: document.getElementById("dond_res_name").innerHTML,
                    lore: document.getElementById("dond_res_desc").innerHTML,
                    img: document.getElementById("dond_res_img").getAttribute("src"),
                })
            }
        }
        document.getElementById("dond_upd").addEventListener("click",upd)
        document.getElementById("dond_prev").addEventListener("click",prv)
        // YOUTUBE 
        socket.on("yt_video_list",(data)=>{
            var parent= document.getElementById("")
            var res = data
            res.forEach((x)=>{
                console.log(x)
                var div = document.createElement("div")
                div.classList.add("row")
                div.classList.add("card")
                var img = document.createElement("img")
                img.classList.add("card-img-top")
                //img.setAttribute("src",x.thumbnails[0])

                div.appendChild(img)
            })
        })
        document.getElementById("yt_search").addEventListener("click",()=>{
            console.log("click")
            var fr = document.getElementById("yt_iframe")
            var se = document.getElementById("yt_search_input").value
            console.log(se)
            if (se!="") {
                socket.emit("get_yt",{
                    limit: 20,
                    id: socket.id,
                    query: se
                })
            }
        })
        // LyricsToJSON
        document.getElementById("LyricsToJSONbtn").addEventListener("click",()=>{
            var digits=["0","1","2","3","4","5","6","7","8","9"]
            /**
             * @type {Array<string>} 
             */
            var v = document.getElementById("LyricsToJSONinput").value.split("\n")
            document.getElementById("LyricsToJSONresult").innerHTML=JSON.stringify({
                text: v.filter(x=>digits.includes(x.trim().charAt(1))).map(e=>{
                    var spl = e.substring(1).split("]")
                    return {timestamp: spl[0], text: spl[1].trim()}
                })
            })
        })
    </script>
</body>

</html>